
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Recolha de Crianças - João Paulo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    ul { list-style: none; padding: 0; }
    li { padding: 5px 0; }
    .present { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Recolha de Crianças - João Paulo</h2>
  <label>Escolhe o dia:</label>
  <input type="date" id="datePicker"><br><br>

  <label>Carregar PDFs/TXT:</label>
  <input type="file" id="pdfInput" multiple accept=".txt,.json"><br><br>

  <ul id="list"></ul>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.107/pdf.min.js"></script>
  <script>
    const datePicker = document.getElementById('datePicker');
    const list = document.getElementById('list');
    const pdfInput = document.getElementById('pdfInput');
    const nomeProcurado = "João Paulo";
    let allChildren = [];

    function normalizeDate(dateStr) {
      const parts = dateStr.split('/');
      if(parts.length === 3) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      return dateStr;
    }

    function renderList(selectedYMD) {
      list.innerHTML = '';
      if (!selectedYMD) {
        list.innerHTML = '<li>Escolhe um dia</li>';
        return;
      }
      const matched = allChildren.filter(c => c.pickupYMD === selectedYMD && c.name.includes(nomeProcurado));
      if(matched.length === 0) {
        list.innerHTML = '<li>Nenhuma criança encontrada para este dia.</li>';
        return;
      }
      matched.forEach((c, i) => {
        const li = document.createElement('li');
        li.textContent = `${c.name} — ${c.pickupYMD} — ${c.time || ''}`;
        const btn = document.createElement('button');
        btn.textContent = 'Presente';
        btn.addEventListener('click', () => li.classList.toggle('present'));
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    datePicker.addEventListener('change', e => renderList(e.target.value));

    pdfInput.addEventListener('change', async e => {
      allChildren = [];
      for (const file of e.target.files) {
        const text = await file.text();
        const lines = text.split('\n');
        lines.forEach(line => {
          const parts = line.split(';');
          if(parts.length >= 2) {
            allChildren.push({
              name: parts[0].trim(),
              pickupYMD: normalizeDate(parts[1].trim()),
              time: parts[2] ? parts[2].trim() : ''
            });
          }
        });
      }
      if(datePicker.value) renderList(datePicker.value);
    });

    const today = new Date();
    datePicker.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  </script>
</body>
</html>
